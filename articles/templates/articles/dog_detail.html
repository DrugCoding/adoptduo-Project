{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/dog_cat_detail.css' %}">

<div>
  <div class="cropped d-flex justify-content-center">
    <img class="cropped_img" src="{% static 'images/dog_test_banner.jpg' %}" alt="">
    <h1 class="main_image_text" style="font-size:60px">ê±´ê°•í•œ
      <span class="colored_text">ë°˜ë ¤ë¬¸í™”</span>ì˜ ì‹œì‘</h1>
    <h1 class="main_image_text_2" style="font-size:40px">í‰ìƒì„
      <span class="colored_text">í•¨ê»˜</span>í•´ ì£¼ì„¸ìš”</h1>
  </div>

  <div class="container mt-4 text-start">
    <div class="d-flex">
      <h2 class="my-auto me-auto">{{ dog_article.title }}</h2>

      <div class="title-info d-flex justify-content-between">
        <h6 class="my-auto">ğŸ•ë¶„ë¥˜: {{ dog_article.dog_breed }}</h6>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

        <h6 class="my-auto">ğŸ‘¤ì‘ì„±ì: 
          <a href="{% url 'accounts:detail' dog_article.user.pk %}" class="text-decoration-none text-dark">{{ dog_article.user.username }}</a>
          {% comment %} ì—´ëŒìì™€ ì‘ì„±ìê°€ ê°™ì§€ ì•Šì„ ë•Œë§Œ ë²„íŠ¼ í™œì„±í™” {% endcomment %}
          <button type="button" 
          class="btn btn-sm mt-1 p-0" 
          data-bs-toggle="popover"
          data-bs-content=
            {% if request.user.pk != dog_article.user.pk  %}
            "<a role='button' class='text-decoration-none' href='{% url 'notes:send' dog_article.user.pk %}'>âœ‰ï¸ë©”ì‹œì§€ë³´ë‚´ê¸°</a><br/>
            <a role='button' class='text-decoration-none' href='{% url 'notes:send' dog_article.user.pk %}'>ğŸ‘€íŒ”ë¡œìš°í•˜ê¸°</a><br/>
            <a role='button' class='text-decoration-none' href='{% url 'notes:send' dog_article.user.pk %}'>ğŸ“ì¶”ê°€ê¸°ëŠ¥2</a>
            "
            {% else %}
            "âœ…ìê¸° ìì‹ ì…ë‹ˆë‹¤!"
            {% endif %}
          data-bs-html="true">â•
          </button>
        </h6>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

        <h6 class="my-auto">ğŸ‘ï¸â€ğŸ—¨ï¸ì¡°íšŒìˆ˜: {{ dog_article.hits }}íšŒ</h6>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

        <h6 class="my-auto"><span>ğŸ”–ì¦ê²¨ì°¾ê¸° ìˆ˜: 
          {% if request.user.is_authenticated %} 
            {% if request.user in dog_article.bookmarks.all %}
              <i id="bookmark-btn" data-article-id="{{ dog_article.pk }}" class="bi-bookmark-heart-fill"></i>
            {% else %}
              <i id="bookmark-btn" data-article-id="{{ dog_article.pk }}" class="bi-bookmark-heart"></i>
            {% endif %}
            <span id="bookmark-count">{{ dog_article.bookmarks.count }}</span>
        </span>
        {% endif %} </h6>
      </div>
    </div>

    <hr id="divider">
  </div>
  <div class="container">
    <div class="article-upd-del text-end">
      <a href="#" class="btn detail_btn2 mx-2 my-3">ğŸ”–ì¦ê²¨ì°¾ê¸° ì¶”ê°€</a>
      <a href="{% url 'articles:dog_update' dog_article.pk %}" class="btn detail_btn2 mx-2 my-3">âœï¸ê¸€ìˆ˜ì •</a>
      <a href="{% url 'articles:dog_delete' dog_article.pk %}" class="btn detail_btn2 mx-2 my-3">ğŸ—‘ï¸ê¸€ì‚­ì œ</a>
    </div>
    <h2 class="text-center mb-3">ì…ì–‘ë™ë¬¼ì •ë³´</h2>
    <div class="text-center">
      <img id="pet-detail-img" class="mb-4 w-25 rounded" src="{{ dog_article.image.url }}" alt="dog_article.image">   
      <div class="d-flex justify-content-center"><p class="text-start w-50">{{ dog_article.content }}</p></div>
    </div>
    <div class="row">
      <div id="pet-info-var-div" class="col-1 text-center py-3">ì´ë¦„</div>
      <div id="pet-info-div" class="col-5 text-center py-3">{{ dog_article.name }}</div>
      <div id="pet-info-var-div" class="col-1 text-center py-3">ë‚˜ì´</div>
      <div id="pet-info-div" class="col-5 text-center py-3">{{ dog_article.age }}ì‚´</div>
    </div>
    <div class="row mt-1">
      <div id="pet-info-var-div" class="col-1 text-center py-3">ì„±ë³„</div>
      <div id="pet-info-div" class="col-5 text-center py-3">{{ dog_article.gender }}</div>
      <div id="pet-info-var-div" class="col-1 text-center py-3">ê²¬ì¢…</div>
      <div id="pet-info-div" class="col-5 text-center py-3">{{ dog_article.dog_breed }}</div>
    </div>
    <div class="row mt-1">
      <div id="pet-info-var-div" class="col-1 text-center py-3">ì ‘ì¢…ìœ ë¬´</div>
      {% if dog_article.vaccination %}
      <div id="pet-info-div" class="col-5 text-center py-3"><span>ì ‘ì¢… ì™„ë£Œ</span></div>
      {% else %}
      <div id="pet-info-div" class="col-5 text-center py-3"><span>ì ‘ì¢… ì•ˆí•¨</span></div>
      {% endif %}
      <div id="pet-info-var-div" class="col-1 text-center py-3">ì¤‘ì„±í™”ìœ ë¬´</div>
      {% if dog_article.neutered %}
      <div id="pet-info-div" class="col-5 text-center py-3"><span>ì¤‘ì„±í™” ì™„ë£Œ</span></div>
      {% else %}
      <div id="pet-info-div" class="col-5 text-center py-3"><span>ì¤‘ì„±í™” ì•ˆí•¨</span></div>
      {% endif %}

    </div>
    <div class="row mt-1">
      <div id="pet-info-var-div" class="col-1 text-center py-3">ì§€ì—­</div>
      <div id="pet-info-div" class="col-5 text-center py-3">{{ dog_article.location }}</div>
      <div id="pet-info-var-div" class="col-1 text-center py-3">íŠ¹ì´ì‚¬í•­</div>
      <div id="pet-info-div" class="col-5 text-center py-3">{{ dog_article.memo }}</div>
    </div>
  </div>
  <div class="container text-center">
    {% comment %} <span>
      {% if request.user.is_authenticated %} 
        {% if request.user in cat_article.bookmarks.all %}
          <i id="bookmark-btn" data-article-id="{{ cat_article.pk }}" class="bi-bookmark-heart-fill fs-1"></i>
        {% else %}
          <i id="bookmark-btn" data-article-id="{{ cat_article.pk }}" class="bi-bookmark-heart fs-1"></i>
        {% endif %}
        <span id="bookmark-count">{{ cat_article.bookmarks.count }}</span>
    </span>
    {% endif %}  {% endcomment %}
    <div>
      <h4 class="mt-5"><span style="color:red">{{ dog_comments.count }}ê°œ</span>ì˜ ëŒ“ê¸€ì´ ìˆìŠµë‹ˆë‹¤.</h4>
      {% for dog_comment in dog_comments %}
      {% csrf_token %}
      <div class="my-4 d-flex" id="{{dog_comment.pk}}">
        <div class="comment-info flex-fill">
          <span>{{ dog_comment.user.username }}&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;ì‘ì„±ì¼ì: {{ dog_comment.created_at }}&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;IP: 121.4945</span>
          <div class="comment-txt mt-3">
            <span>{{ dog_comment.content }}</span>
          </div>
        </div>
        <span class="comment-delete mx-5 my-4 align-items-center"><button class="comment-del-btn Nanum" data-comment-id="{{dog_comment.pk}}" onclick="remove(event)">ëŒ“ê¸€ì‚­ì œ</button></span>
      </div>
      
      {% endfor %}
    </div>
    <form data-article-id="{{ dog_article.pk }}">
        {% csrf_token %}
        {% bootstrap_form dog_comment_form %}
        {% bootstrap_button content="ok" button_type="submit" button_class="btn-danger col-3" %}
    </form>
    <hr>
  </div>
  <div id="map" style="width:100%;height:350px;"></div>
  <p><em>ì§€ë„ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”!</em></p> 
  <div id="clickLatlng"></div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e6496a8841e6155cd7af237e16b93602&libraries=services"></script>
<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>
<script>
    $(document).ready(function(){ //íŒì˜¤ë²„ ì‘ë™í•˜ê²Œ í•˜ê¸°
      $('[data-bs-toggle="popover"]').popover();
    });
    const commentForm = document.querySelector('#dog-comment-form')
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    commentForm.addEventListener('submit', function(event){
        event.preventDefault();
        axios({
          method: 'post',
          url: `/${event.target.dataset.articleId}/dog/comments/`,
          headers: {'X-CSRFToken': csrftoken},
          data: new FormData(commentForm) // í¼ì— ìˆëŠ” ì •ë³´ë¥¼ dataë¡œ ë„˜ê²¨ì¤„ ìˆ˜ ìˆë„ë¡ ë³€í™˜
        })
        .then(response => {
          console.log(response.data)
          // ëŒ“ê¸€ì„ ì¶”ê°€í•˜ëŠ” ë¡œì§
          const comments = document.querySelector('#dog-comments')
          const div = document.createElement('div')
          div.id = response.data.dog_pk
          const p = document.createElement('p')
          p.innerText = `${response.data.dog_userName} | ${response.data.dog_content}`
          const hr = document.createElement('hr')
          const btn = document.createElement('button')
          btn.innerText = 'ëŒ“ê¸€ ì‚­ì œ'
          btn.dataset.commentId = response.data.dog_pk
          btn.onclick = remove;
          div.appendChild(p)
          div.appendChild(btn)
          div.appendChild(hr)
          comments.appendChild(div) 
          commentForm.reset()
        })
      })
      function remove(e) {
        console.log(e.target.dataset.commentId)
        var delete_warning = confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
        const commentForm = document.querySelector('#dog-comment-form')
        if (delete_warning === true) {
          axios({
            method: 'post',
            url: `/${commentForm.dataset.articleId}/comments/${event.target.dataset.commentId}/dog/delete/`,
            headers: {'X-CSRFToken': csrftoken},
          })
          .then(response => {
            const div = document.getElementById(e.target.dataset.commentId)
            div.remove()
          })
        }
      }
    const bookmarkBtn = document.querySelector('#bookmark-btn')
    bookmarkBtn.addEventListener('click', function (event){
        console.log(event.target.dataset)
        axios({
            method: 'get',
            url: `/${event.target.dataset.articleId}/dog/bookmark/` //ì„œë²„ì— ìš”ì²­ ë³´ëƒˆê³ , 
        })
        .then(context => {
            console.log(context)
            console.log(context.data)
            if (context.data.isbookmarked === true) {
              event.target.classList.add('bi-bookmark-heart-fill')
              event.target.classList.remove('bi-bookmark-heart')
            } else {
              event.target.classList.add('bi-bookmark-heart')
              event.target.classList.remove('bi-bookmark-heart-fill')
            }
            const bookmarkCount = document.querySelector('#bookmark-count')
            bookmarkCount.innerText = context.data.bookmarkcount
        }) // ëŒì•„ì˜¤ë©´ ì–´ë–¤ê±¸ í•˜ê³  ì‹¶ì€ê°€?
    }) 
    var latlng = JSON.parse("{{ latlngjson|escapejs }}")
    var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div 
    mapOption = { 
        center: new kakao.maps.LatLng(latlng['lat'], latlng['lng']), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
        level: 3 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
    };

    var map = new kakao.maps.Map(mapContainer, mapOption); // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤

    // ì§€ë„ë¥¼ í´ë¦­í•œ ìœ„ì¹˜ì— í‘œì¶œí•  ë§ˆì»¤ì…ë‹ˆë‹¤
    var marker = new kakao.maps.Marker({ 
        // ì§€ë„ ì¤‘ì‹¬ì¢Œí‘œì— ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤ 
        position: map.getCenter() 
    }); 
    // ì§€ë„ì— ë§ˆì»¤ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
    marker.setMap(map);

    // ì§€ë„ì— í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
    // ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ë§ˆì§€ë§‰ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {        
        
        // í´ë¦­í•œ ìœ„ë„, ê²½ë„ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤ 
        var latlng = mouseEvent.latLng; 
        
        // ë§ˆì»¤ ìœ„ì¹˜ë¥¼ í´ë¦­í•œ ìœ„ì¹˜ë¡œ ì˜®ê¹ë‹ˆë‹¤
        marker.setPosition(latlng);
        
        var message = 'í´ë¦­í•œ ìœ„ì¹˜ì˜ ìœ„ë„ëŠ” ' + latlng.getLat() + ' ì´ê³ , ';
        message += 'ê²½ë„ëŠ” ' + latlng.getLng() + ' ì…ë‹ˆë‹¤';
        
        var resultDiv = document.getElementById('clickLatlng'); 
        resultDiv.innerHTML = message;
        
    }); 
    {% comment %} var latlng = JSON.parse("{{ latlngjson|escapejs }}")
    var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div 
        mapOption = {
            center: new kakao.maps.LatLng(latlng['lat'], latlng['lng']), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
            level: 1 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
        };  

    // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤    
    var map = new kakao.maps.Map(mapContainer, mapOption); 

    // ì£¼ì†Œ-ì¢Œí‘œ ë³€í™˜ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var geocoder = new kakao.maps.services.Geocoder();

    var marker = new kakao.maps.Marker(), // í´ë¦­í•œ ìœ„ì¹˜ë¥¼ í‘œì‹œí•  ë§ˆì»¤ì…ë‹ˆë‹¤
        infowindow = new kakao.maps.InfoWindow({zindex:1}); // í´ë¦­í•œ ìœ„ì¹˜ì— ëŒ€í•œ ì£¼ì†Œë¥¼ í‘œì‹œí•  ì¸í¬ìœˆë„ìš°ì…ë‹ˆë‹¤
    // í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ì¢Œí‘œë¡œ ì£¼ì†Œë¥¼ ê²€ìƒ‰í•´ì„œ ì§€ë„ ì¢Œì¸¡ ìƒë‹¨ì— í‘œì‹œí•©ë‹ˆë‹¤
    searchAddrFromCoords(map.getCenter(), displayCenterInfo);

    // ì§€ë„ë¥¼ í´ë¦­í–ˆì„ ë•Œ í´ë¦­ ìœ„ì¹˜ ì¢Œí‘œì— ëŒ€í•œ ì£¼ì†Œì •ë³´ë¥¼ í‘œì‹œí•˜ë„ë¡ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        searchDetailAddrFromCoords(mouseEvent.latLng, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var detailAddr = !!result[0].road_address ? '<div>ë„ë¡œëª…ì£¼ì†Œ : ' + result[0].road_address.address_name + '</div>' : '';
                detailAddr += '<div>ì§€ë²ˆ ì£¼ì†Œ : ' + result[0].address.address_name + '</div>';
                
                var content = '<div class="bAddr">' +
                                '<span class="title">ë²•ì •ë™ ì£¼ì†Œì •ë³´</span>' + 
                                detailAddr + 
                            '</div>';

                // ë§ˆì»¤ë¥¼ í´ë¦­í•œ ìœ„ì¹˜ì— í‘œì‹œí•©ë‹ˆë‹¤ 
                marker.setPosition(mouseEvent.latLng);
                marker.setMap(map);

                // ì¸í¬ìœˆë„ìš°ì— í´ë¦­í•œ ìœ„ì¹˜ì— ëŒ€í•œ ë²•ì •ë™ ìƒì„¸ ì£¼ì†Œì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
                infowindow.setContent(content);
                infowindow.open(map, marker);
            }   
        });
    });
    // ì¤‘ì‹¬ ì¢Œí‘œë‚˜ í™•ëŒ€ ìˆ˜ì¤€ì´ ë³€ê²½ëì„ ë•Œ ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œì— ëŒ€í•œ ì£¼ì†Œ ì •ë³´ë¥¼ í‘œì‹œí•˜ë„ë¡ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
    kakao.maps.event.addListener(map, 'idle', function() {
      searchAddrFromCoords(map.getCenter(), displayCenterInfo);
    });

    function searchAddrFromCoords(coords, callback) {
      // ì¢Œí‘œë¡œ í–‰ì •ë™ ì£¼ì†Œ ì •ë³´ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤
      geocoder.coord2RegionCode(coords.getLng(), coords.getLat(), callback);         
    }

    function searchDetailAddrFromCoords(coords, callback) {
      // ì¢Œí‘œë¡œ ë²•ì •ë™ ìƒì„¸ ì£¼ì†Œ ì •ë³´ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤
      geocoder.coord2Address(coords.getLng(), coords.getLat(), callback);
    }

    // ì§€ë„ ì¢Œì¸¡ìƒë‹¨ì— ì§€ë„ ì¤‘ì‹¬ì¢Œí‘œì— ëŒ€í•œ ì£¼ì†Œì •ë³´ë¥¼ í‘œì¶œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
    function displayCenterInfo(result, status) {
      if (status === kakao.maps.services.Status.OK) {
          var infoDiv = document.getElementById('centerAddr');

          for(var i = 0; i < result.length; i++) {
              // í–‰ì •ë™ì˜ region_type ê°’ì€ 'H' ì´ë¯€ë¡œ
              if (result[i].region_type === 'H') {
                  infoDiv.innerHTML = result[i].address_name;
                  break;
              }
          }
      }    
    } {% endcomment %}

</script>
{% endblock %}